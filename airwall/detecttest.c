#include <errno.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <stdlib.h>
#include "detect.h"

static void gen_1b_fragment(const void *hldata, int i, char fragment[6])
{
  const unsigned char *hludata = hldata;
  fragment[0] = 0x16;
  fragment[1] = 0x03;
  fragment[2] = 0x01;
  fragment[3] = 0;
  fragment[4] = 1;
  fragment[5] = hludata[i];
}

static void http_connect_test(void)
{
  struct http_ctx ctx = {};
  struct hostname_ctx nam = {};
  char *str0 = "CONNECT example.host.com:22 HTTP/1.1\r\n\r\n";
  char *str1 = "CONNECT example.host.com:22 HTTP/1.1\r\nHost: www.google.fi\r\n\r\n";
  char *str2 = "CONNECT example.host.com:22 HTTP/1.1\r\nA: B\r\nHost: www.google.fi\r\n\r\n";
  char *str3 = "CONNECT example.host.com:22 HTTP/1.1\r\nA: B\r\n\r\nHost: www.google.fi\r\n\r\n";
  char *str3_reqonly = "CONNECT example.host.com:22 HTTP/1.1\r\nA: B\r\n\r\n";
  int ret;

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  ret = http_ctx_feed(&ctx, str0, strlen(str0), &nam);
  printf("0: %d\n", ret);
  printf("%s\n", nam.hostname);
  if (ret != 0)
  {
    printf("ret err\n");
    abort();
  }
  if (strcmp(nam.hostname, "example.host.com:22") != 0)
  {
    printf("host err\n");
    abort();
  }
  if (nam.is_http_connect_num_bytes != (int)strlen(str0))
  {
    printf("num err %d %d\n", nam.is_http_connect_num_bytes, (int)strlen(str0));
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  ret = http_ctx_feed(&ctx, str1, strlen(str1), &nam);
  printf("1: %d\n", ret);
  printf("%s\n", nam.hostname);
  if (ret != 0)
  {
    printf("ret err\n");
    abort();
  }
  if (strcmp(nam.hostname, "example.host.com:22") != 0)
  {
    printf("host err\n");
    abort();
  }
  if (nam.is_http_connect_num_bytes != (int)strlen(str1))
  {
    printf("num err %d %d\n", nam.is_http_connect_num_bytes, (int)strlen(str1));
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  ret = http_ctx_feed(&ctx, str2, strlen(str2), &nam);
  printf("2: %d\n", ret);
  printf("%s\n", nam.hostname);
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "example.host.com:22") != 0)
  {
    abort();
  }
  if (nam.is_http_connect_num_bytes != (int)strlen(str2))
  {
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  ret = http_ctx_feed(&ctx, str3, strlen(str3), &nam);
  printf("3: %d\n", ret);
  printf("%s\n", nam.hostname);
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "example.host.com:22") != 0)
  {
    abort();
  }
  if (nam.is_http_connect_num_bytes != (int)strlen(str3_reqonly))
  {
    abort();
  }
}

static void http_test(void)
{
  struct http_ctx ctx = {};
  struct hostname_ctx nam = {};
  char *str1 = "GET / HTTP/1.1\r\nHost: www.google.fi\r\n\r\n";
  char *str2 = "GET / HTTP/1.1\r\nA: B\r\nHost: www.google.fi\r\n\r\n";
  char *str3 = "GET / HTTP/1.1\r\nA: B\r\n\r\nHost: www.google.fi\r\n\r\n";
  char *strnocr = "GET / HTTP/1.1\nHost: www.google.fi\n\n";
  size_t i;
  int ret;

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  ret = http_ctx_feed(&ctx, strnocr, strlen(strnocr), &nam);
  printf("nocr: %d\n", ret);
  printf("%s\n", nam.hostname);
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "www.google.fi") != 0)
  {
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  ret = http_ctx_feed(&ctx, str1, strlen(str1), &nam);
  printf("1: %d\n", ret);
  printf("%s\n", nam.hostname);
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "www.google.fi") != 0)
  {
    abort();
  }
  if (nam.is_http_connect_num_bytes != 0)
  {
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  ret = http_ctx_feed(&ctx, str2, strlen(str2), &nam);
  printf("2: %d\n", ret);
  printf("%s\n", nam.hostname);
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "www.google.fi") != 0)
  {
    abort();
  }
  if (nam.is_http_connect_num_bytes != 0)
  {
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  ret = http_ctx_feed(&ctx, str3, strlen(str3), &nam);
  printf("3: %d\n", ret);
  printf("%s\n", nam.hostname);
  if (ret != -95)
  {
    abort();
  }
  if (strcmp(nam.hostname, "") != 0)
  {
    abort();
  }
  if (nam.is_http_connect_num_bytes != 0)
  {
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  for (i = 0; i < strlen(str1); i++)
  {
    ret = http_ctx_feed(&ctx, &str1[i], 1, &nam);
    if (ret != -EAGAIN)
    {
      printf("1: %d\n", ret);
      printf("%s\n", nam.hostname);
      break;
    }
  }
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "www.google.fi") != 0)
  {
    abort();
  }
  if (nam.is_http_connect_num_bytes != 0)
  {
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  for (i = 0; i < strlen(str2); i++)
  {
    ret = http_ctx_feed(&ctx, &str2[i], 1, &nam);
    if (ret != -EAGAIN)
    {
      printf("2: %d\n", ret);
      printf("%s\n", nam.hostname);
      break;
    }
  }
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "www.google.fi") != 0)
  {
    abort();
  }
  if (nam.is_http_connect_num_bytes != 0)
  {
    abort();
  }

  http_ctx_init(&ctx);
  hostname_ctx_init(&nam);
  for (i = 0; i < strlen(str3); i++)
  {
    ret = http_ctx_feed(&ctx, &str3[i], 1, &nam);
    if (ret != -EAGAIN)
    {
      printf("3: %d\n", ret);
      printf("%s\n", nam.hostname);
      break;
    }
  }
  if (ret != -95)
  {
    abort();
  }
  if (strcmp(nam.hostname, "") != 0)
  {
    abort();
  }
  if (nam.is_http_connect_num_bytes != 0)
  {
    abort();
  }
}

int main(int argc, char **argv)
{
  char fragment[6] = {0};
  char nosni[] = {
    0x16,0x03,0x01,0x00,0xab,0x01,0x00,0x00,
    0xa7,0x03,0x03,0xcf,0xb5,0x6a,0x3b,0x6f,
    0x38,0x2a,0x70,0xeb,0xee,0x7c,0x50,0x8b,
    0xbc,0xd0,0xea,0xcb,0xc6,0x7a,0xef,0x51,
    0xa3,0x59,0x67,0x6c,0x70,0xb9,0x76,0x75,
    0x78,0x3d,0xc5,0x00,0x00,0x38,0xc0,0x2c,
    0xc0,0x30,0x00,0x9f,0xcc,0xa9,0xcc,0xa8,
    0xcc,0xaa,0xc0,0x2b,0xc0,0x2f,0x00,0x9e,
    0xc0,0x24,0xc0,0x28,0x00,0x6b,0xc0,0x23,
    0xc0,0x27,0x00,0x67,0xc0,0x0a,0xc0,0x14,
    0x00,0x39,0xc0,0x09,0xc0,0x13,0x00,0x33,
    0x00,0x9d,0x00,0x9c,0x00,0x3d,0x00,0x3c,
    0x00,0x35,0x00,0x2f,0x00,0xff,0x01,0x00,
    0x00,0x46,0x00,0x0b,0x00,0x04,0x03,0x00,
    0x01,0x02,0x00,0x0a,0x00,0x0a,0x00,0x08,
    0x00,0x1d,0x00,0x17,0x00,0x19,0x00,0x18,
    0x00,0x23,0x00,0x00,0x00,0x16,0x00,0x00,
    0x00,0x17,0x00,0x00,0x00,0x0d,0x00,0x20,
    0x00,0x1e,0x06,0x01,0x06,0x02,0x06,0x03,
    0x05,0x01,0x05,0x02,0x05,0x03,0x04,0x01,
    0x04,0x02,0x04,0x03,0x03,0x01,0x03,0x02,
    0x03,0x03,0x02,0x01,0x02,0x02,0x02,0x03,
  };
  char nosnihl[] = {
    0x01,0x00,0x00,
    0xa7,0x03,0x03,0xcf,0xb5,0x6a,0x3b,0x6f,
    0x38,0x2a,0x70,0xeb,0xee,0x7c,0x50,0x8b,
    0xbc,0xd0,0xea,0xcb,0xc6,0x7a,0xef,0x51,
    0xa3,0x59,0x67,0x6c,0x70,0xb9,0x76,0x75,
    0x78,0x3d,0xc5,0x00,0x00,0x38,0xc0,0x2c,
    0xc0,0x30,0x00,0x9f,0xcc,0xa9,0xcc,0xa8,
    0xcc,0xaa,0xc0,0x2b,0xc0,0x2f,0x00,0x9e,
    0xc0,0x24,0xc0,0x28,0x00,0x6b,0xc0,0x23,
    0xc0,0x27,0x00,0x67,0xc0,0x0a,0xc0,0x14,
    0x00,0x39,0xc0,0x09,0xc0,0x13,0x00,0x33,
    0x00,0x9d,0x00,0x9c,0x00,0x3d,0x00,0x3c,
    0x00,0x35,0x00,0x2f,0x00,0xff,0x01,0x00,
    0x00,0x46,0x00,0x0b,0x00,0x04,0x03,0x00,
    0x01,0x02,0x00,0x0a,0x00,0x0a,0x00,0x08,
    0x00,0x1d,0x00,0x17,0x00,0x19,0x00,0x18,
    0x00,0x23,0x00,0x00,0x00,0x16,0x00,0x00,
    0x00,0x17,0x00,0x00,0x00,0x0d,0x00,0x20,
    0x00,0x1e,0x06,0x01,0x06,0x02,0x06,0x03,
    0x05,0x01,0x05,0x02,0x05,0x03,0x04,0x01,
    0x04,0x02,0x04,0x03,0x03,0x01,0x03,0x02,
    0x03,0x03,0x02,0x01,0x02,0x02,0x02,0x03,
  };
  char withsni[] = {
0x16,0x03,0x01,0x00,0xbd,0x01,0x00,0x00,0xb9,0x03,0x03,0x8a,0x80,0x22,0x0f,0x8d
,0x60,0x13,0x99,0x8b,0x4b,0xfa,0x96,0xba,0x7a,0xeb,0x81,0x60,0x80,0xe4,0xc7,0x9e
,0xd0,0x4e,0x18,0x4e,0xc5,0xd5,0x74,0x17,0x23,0xb1,0xa1,0x00,0x00,0x38,0xc0,0x2c
,0xc0,0x30,0x00,0x9f,0xcc,0xa9,0xcc,0xa8,0xcc,0xaa,0xc0,0x2b,0xc0,0x2f,0x00,0x9e
,0xc0,0x24,0xc0,0x28,0x00,0x6b,0xc0,0x23,0xc0,0x27,0x00,0x67,0xc0,0x0a,0xc0,0x14
,0x00,0x39,0xc0,0x09,0xc0,0x13,0x00,0x33,0x00,0x9d,0x00,0x9c,0x00,0x3d,0x00,0x3c
,0x00,0x35,0x00,0x2f,0x00,0xff,0x01,0x00,0x00,0x58,0x00,0x00,0x00,0x0e,0x00,0x0c
,0x00,0x00,0x09,0x6c,0x6f,0x63,0x61,0x6c,0x68,0x6f,0x73,0x74,0x00,0x0b,0x00,0x04
,0x03,0x00,0x01,0x02,0x00,0x0a,0x00,0x0a,0x00,0x08,0x00,0x1d,0x00,0x17,0x00,0x19
,0x00,0x18,0x00,0x23,0x00,0x00,0x00,0x16,0x00,0x00,0x00,0x17,0x00,0x00,0x00,0x0d
,0x00,0x20,0x00,0x1e,0x06,0x01,0x06,0x02,0x06,0x03,0x05,0x01,0x05,0x02,0x05,0x03
,0x04,0x01,0x04,0x02,0x04,0x03,0x03,0x01,0x03,0x02,0x03,0x03,0x02,0x01,0x02,0x02
,0x02,0x03
  };
  char withsnihl[] = {
0x01,0x00,0x00,0xb9,0x03,0x03,0x8a,0x80,0x22,0x0f,0x8d
,0x60,0x13,0x99,0x8b,0x4b,0xfa,0x96,0xba,0x7a,0xeb,0x81,0x60,0x80,0xe4,0xc7,0x9e
,0xd0,0x4e,0x18,0x4e,0xc5,0xd5,0x74,0x17,0x23,0xb1,0xa1,0x00,0x00,0x38,0xc0,0x2c
,0xc0,0x30,0x00,0x9f,0xcc,0xa9,0xcc,0xa8,0xcc,0xaa,0xc0,0x2b,0xc0,0x2f,0x00,0x9e
,0xc0,0x24,0xc0,0x28,0x00,0x6b,0xc0,0x23,0xc0,0x27,0x00,0x67,0xc0,0x0a,0xc0,0x14
,0x00,0x39,0xc0,0x09,0xc0,0x13,0x00,0x33,0x00,0x9d,0x00,0x9c,0x00,0x3d,0x00,0x3c
,0x00,0x35,0x00,0x2f,0x00,0xff,0x01,0x00,0x00,0x58,0x00,0x00,0x00,0x0e,0x00,0x0c
,0x00,0x00,0x09,0x6c,0x6f,0x63,0x61,0x6c,0x68,0x6f,0x73,0x74,0x00,0x0b,0x00,0x04
,0x03,0x00,0x01,0x02,0x00,0x0a,0x00,0x0a,0x00,0x08,0x00,0x1d,0x00,0x17,0x00,0x19
,0x00,0x18,0x00,0x23,0x00,0x00,0x00,0x16,0x00,0x00,0x00,0x17,0x00,0x00,0x00,0x0d
,0x00,0x20,0x00,0x1e,0x06,0x01,0x06,0x02,0x06,0x03,0x05,0x01,0x05,0x02,0x05,0x03
,0x04,0x01,0x04,0x02,0x04,0x03,0x03,0x01,0x03,0x02,0x03,0x03,0x02,0x01,0x02,0x02
,0x02,0x03
  };
  struct ssl_fragment_ctx fragctx;
  size_t i, j;
  struct hostname_ctx nam;
  int ret;

  ssl_fragment_ctx_init(&fragctx);
  hostname_ctx_init(&nam);

  ret = ssl_fragment_ctx_feed(&fragctx, withsni, sizeof(withsni), &nam);
  printf("%d (expected 0)\n", ret);
  printf("%s (expected localhost)\n", nam.hostname);

  ssl_fragment_ctx_init(&fragctx);
  hostname_ctx_init(&nam);

  ret = ssl_fragment_ctx_feed(&fragctx, nosni, sizeof(nosni), &nam);
  printf("%d (expected -95)\n", ret);
  printf("%s (expected )\n", nam.hostname);

  printf("---\n");
  ssl_fragment_ctx_init(&fragctx);
  hostname_ctx_init(&nam);
  for (i = 0; i < sizeof(withsnihl); i++)
  {
    gen_1b_fragment(withsnihl, i, fragment);
    ret = ssl_fragment_ctx_feed(&fragctx, fragment, sizeof(fragment), &nam);
    if (ret != -EAGAIN)
    {
      printf("%d (expected 0)\n", ret);
      printf("%s (exptected localhost)\n", nam.hostname);
      break;
    }
    //ssl_fragment_ctx_reset(&fragctx); // FIXME should this be automatic?
  }
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "localhost") != 0)
  {
    abort();
  }

  printf("===\n");
  ssl_fragment_ctx_init(&fragctx);
  hostname_ctx_init(&nam);
  for (i = 0; i < sizeof(nosnihl); i++)
  {
    gen_1b_fragment(nosnihl, i, fragment);
    ret = ssl_fragment_ctx_feed(&fragctx, fragment, sizeof(fragment), &nam);
    if (ret != -EAGAIN)
    {
      printf("%d (expected -95)\n", ret);
      printf("%s (expected )\n", nam.hostname);
      break;
    }
    //ssl_fragment_ctx_reset(&fragctx); // FIXME should this be automatic?
  }
  if (ret != -95)
  {
    abort();
  }
  if (strcmp(nam.hostname, "") != 0)
  {
    abort();
  }

  printf("###\n");
  ssl_fragment_ctx_init(&fragctx);
  hostname_ctx_init(&nam);
  for (i = 0; i < sizeof(withsnihl); i++)
  {
    gen_1b_fragment(withsnihl, i, fragment);
    for (j = 0; j < sizeof(fragment); j++)
    {
        ret = ssl_fragment_ctx_feed(&fragctx, fragment+j, 1, &nam);
        if (ret != -EAGAIN)
        {
          printf("%d (expected 0)\n", ret);
          printf("%s (expected localhost)\n", nam.hostname);
          goto out;
        }
    }
    //ssl_fragment_ctx_reset(&fragctx);
  }
out:
  if (ret != 0)
  {
    abort();
  }
  if (strcmp(nam.hostname, "localhost") != 0)
  {
    abort();
  }

  printf("HTTP\n");

  http_test();

  http_connect_test();

  return 0;
}
